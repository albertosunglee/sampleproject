name: UAT Delta Deployment (JWT + sfdx-git-delta)

on:
  push:
    branches: [UAT]
  workflow_dispatch:

env:
  SFDX_CLI_VERSION: latest
  NODE_VERSION: "20" # SGD v6 needs Node 20+ for the sf CLI runtime
  SF_LOGIN_URL: https://test.salesforce.com
  HALT_ON_DRIFT: false # Set to true to halt deployment when drift is detected

jobs:
  delta-deployment:
    name: UAT Delta Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure full git history / remotes
        run: |
          git fetch --all --prune
          git branch -vv

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Install Salesforce CLI + sfdx-git-delta
        run: |
          npm install -g @salesforce/cli@${{ env.SFDX_CLI_VERSION }}
          sf --version
          # Pin via org-level variable SGD_VERSION if you like (e.g., v6.17.0)
          echo y | sf plugins install "sfdx-git-delta@${{ vars.SGD_VERSION || 'latest' }}"
          sf plugins

      - name: Authenticate to UAT (JWT)
        run: |
          echo "${{ secrets.SF_UAT_PRIVATE_KEY }}" > uat_private_key.key
          chmod 600 uat_private_key.key
          sf org login jwt \
            --client-id "${{ secrets.SF_UAT_CLIENT_ID }}" \
            --jwt-key-file uat_private_key.key \
            --username "${{ secrets.SF_UAT_USERNAME }}" \
            --instance-url "${{ env.SF_LOGIN_URL }}" \
            --alias uat-org
          rm uat_private_key.key
          sf org display --target-org uat-org

      - name: Compute FROM ref
        id: base
        shell: bash
        run: |
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            FROM_REF="${{ github.event.before }}"
          else
            # first push to UAT: diff against UAT
            git fetch origin UAT:origin/UAT || true
            FROM_REF="origin/UAT"
          fi
          echo "from_ref=$FROM_REF" >> "$GITHUB_OUTPUT"
          echo "Comparing FROM: $FROM_REF  TO: HEAD"

      - name: Generate delta (SGD)
        id: sgd
        run: |
          mkdir -p delta
          # Limit to force-app (faster) and generate source + manifests
          sf sgd source delta \
            --from "${{ steps.base.outputs.from_ref }}" \
            --to "HEAD" \
            --source-dir "force-app" \
            --output-dir "delta" \
            --generate-delta
          echo "Delta contents:"
          ls -R delta || true

      - name: Show manifests
        run: |
          echo "---- package.xml ----"
          cat delta/package/package.xml || true
          echo
          echo "---- destructiveChanges.xml ----"
          cat delta/destructiveChanges/destructiveChanges.xml || true

      - name: Delta-based Drift Detection
        id: drift_check
        run: |
          echo "üîç Checking for drift in metadata to be deployed (delta-based)..."

          # Create drift detection directories
          mkdir -p drift-check/org-delta-metadata
          mkdir -p drift-check/repo-delta-metadata

          # Check if we have a delta package to analyze
          if [ -f delta/package/package.xml ] && grep -q "<types>" delta/package/package.xml; then
            echo "üì¶ Analyzing delta package for drift detection..."
            
            # Copy delta metadata from repository to drift-check
            if [ -d "delta" ]; then
              cp -r delta/ drift-check/repo-delta-metadata/ || true
            fi
            
            # Retrieve ONLY the delta metadata from the org for comparison
            echo "üì• Retrieving delta metadata from UAT org..."
            sf project retrieve start \
              --manifest delta/package/package.xml \
              --target-org uat-org \
              --target-metadata-dir drift-check/org-delta-metadata \
              --wait 30 || true
            
            # Compare delta metadata between org and repository
            DRIFT_DETECTED=false
            if [ -d "drift-check/org-delta-metadata" ] && [ -d "drift-check/repo-delta-metadata" ]; then
              # Compare only the source metadata (not the generated manifests)
              if [ -d "drift-check/org-delta-metadata/force-app" ] && [ -d "delta" ]; then
                if ! diff -r -q delta/ drift-check/org-delta-metadata/ > drift-check/drift-summary.txt 2>&1; then
                  DRIFT_DETECTED=true
                  echo "‚ö†Ô∏è  DELTA DRIFT DETECTED: UAT org differs from repository for deployment metadata!"
                  echo "üìÅ Drift details saved to drift-check/ folder"
                  
                  # Create detailed drift report
                  echo "# UAT Org Delta Drift Detection Report" > drift-check/DRIFT_REPORT.md
                  echo "**Detection Date:** $(date)" >> drift-check/DRIFT_REPORT.md
                  echo "**Branch:** ${{ github.ref_name }}" >> drift-check/DRIFT_REPORT.md
                  echo "**Commit:** ${{ github.sha }}" >> drift-check/DRIFT_REPORT.md
                  echo "**Deployment Type:** Delta-based" >> drift-check/DRIFT_REPORT.md
                  echo "" >> drift-check/DRIFT_REPORT.md
                  echo "## Summary" >> drift-check/DRIFT_REPORT.md
                  echo "The UAT org contains different versions of metadata that you are about to deploy." >> drift-check/DRIFT_REPORT.md
                  echo "This means someone may have made changes directly in the org that conflict with your deployment." >> drift-check/DRIFT_REPORT.md
                  echo "" >> drift-check/DRIFT_REPORT.md
                  echo "## Delta Package Being Deployed" >> drift-check/DRIFT_REPORT.md
                  echo "\`\`\`xml" >> drift-check/DRIFT_REPORT.md
                  cat delta/package/package.xml >> drift-check/DRIFT_REPORT.md
                  echo "\`\`\`" >> drift-check/DRIFT_REPORT.md
                  echo "" >> drift-check/DRIFT_REPORT.md
                  echo "## Differences Found in Delta Metadata" >> drift-check/DRIFT_REPORT.md
                  echo "\`\`\`" >> drift-check/DRIFT_REPORT.md
                  cat drift-check/drift-summary.txt >> drift-check/DRIFT_REPORT.md
                  echo "\`\`\`" >> drift-check/DRIFT_REPORT.md
                  echo "" >> drift-check/DRIFT_REPORT.md
                  echo "## Actions Required" >> drift-check/DRIFT_REPORT.md
                  echo "1. **Critical**: Review drift in metadata you're about to deploy" >> drift-check/DRIFT_REPORT.md
                  echo "2. Check \`org-delta-metadata/\` folder to see current org state of delta metadata" >> drift-check/DRIFT_REPORT.md
                  echo "3. Check \`repo-delta-metadata/\` folder to see repository state of delta metadata" >> drift-check/DRIFT_REPORT.md
                  echo "4. Decide whether to:" >> drift-check/DRIFT_REPORT.md
                  echo "   - **Continue**: Deploy and overwrite org changes (will lose org modifications)" >> drift-check/DRIFT_REPORT.md
                  echo "   - **Halt**: Stop deployment and manually sync the drift first" >> drift-check/DRIFT_REPORT.md
                  echo "   - **Investigate**: Review each conflicting file individually" >> drift-check/DRIFT_REPORT.md
                  
                  # Output for GitHub Actions
                  echo "üìã Delta drift summary:"
                  cat drift-check/drift-summary.txt
                else
                  echo "‚úÖ No drift detected in delta metadata - org and repository are aligned for deployment"
                fi
              else
                echo "‚ö†Ô∏è  Could not compare delta metadata properly"
                DRIFT_DETECTED=false
              fi
            else
              echo "‚ö†Ô∏è  Could not retrieve delta metadata from org for drift comparison"
              DRIFT_DETECTED=false
            fi
          else
            echo "‚ÑπÔ∏è  No delta package found - skipping drift detection"
            DRIFT_DETECTED=false
          fi

          echo "drift_detected=$DRIFT_DETECTED" >> "$GITHUB_OUTPUT"

      - name: Handle Delta Drift Detection Results
        run: |
          if [ "${{ steps.drift_check.outputs.drift_detected }}" == "true" ]; then
            echo "‚ö†Ô∏è  DELTA DRIFT DETECTED BEFORE DEPLOYMENT!"
            echo "üìã This means the metadata you're about to deploy differs from what's currently in the UAT org."
            echo ""
            cat drift-check/DRIFT_REPORT.md || true
            echo ""
            
            if [ "${{ env.HALT_ON_DRIFT }}" == "true" ]; then
              echo "‚ùå HALTING DEPLOYMENT due to detected delta drift (HALT_ON_DRIFT=true)"
              echo "Please review the drift-check artifact and resolve differences before deploying."
              echo "The conflicting metadata must be synchronized before deployment can proceed."
              exit 1
            else
              echo "‚ö†Ô∏è  PROCEEDING WITH DEPLOYMENT despite delta drift (HALT_ON_DRIFT=false)"
              echo "‚ö†Ô∏è  WARNING: This deployment will overwrite the detected org changes in the delta metadata!"
              echo "üîÑ Any changes made directly in the org for the affected metadata will be lost."
            fi
          else
            echo "‚úÖ No delta drift detected - proceeding with deployment"
            echo "üì¶ Delta metadata in org matches repository - safe to deploy"
          fi

      - name: Deploy added/modified metadata to UAT
        id: deploy_pkg
        run: |
          if [ -f delta/package/package.xml ] && grep -q "<types>" delta/package/package.xml; then
            sf project deploy start \
              -x delta/package/package.xml \
              --target-org uat-org \
              --wait 60
            echo "did_pkg=true" >> "$GITHUB_OUTPUT"
          else
            echo "No package changes to deploy."
            echo "did_pkg=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run targeted Apex tests (if Apex classes changed)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          pip install yq  # provides `xq`
          TESTS=$(xq . < delta/package/package.xml | jq -r '
            .Package.types
            | (if type=="array" then . else [.] end)
            | map(select(.name=="ApexClass"))
            | .[].members
            | (if type=="array" then . else [.] end)
            | map(select(. | index("*") | not))
            | unique
            | join(",")
          ')
          if [ -n "$TESTS" ]; then
            echo "Running specified tests: $TESTS"
            sf apex run test \
              --target-org uat-org \
              --test-level RunSpecifiedTests \
              --tests "$TESTS" \
              --wait 60 \
              --result-format human
          else
            echo "No Apex class changes; running RunLocalTests."
            sf apex run test \
              --target-org uat-org \
              --test-level RunLocalTests \
              --wait 60 \
              --result-format human
          fi

      - name: Apply destructive changes (if any)
        run: |
          if [ -f delta/destructiveChanges/destructiveChanges.xml ] && grep -q "<types>" delta/destructiveChanges/destructiveChanges.xml; then
            # Use the minimal manifest generated alongside destructiveChanges
            sf project deploy start \
              --post-destructive-changes delta/destructiveChanges/destructiveChanges.xml \
              --manifest delta/destructiveChanges/package.xml \
              --target-org uat-org \
              --ignore-warnings \
              --wait 60
          else
            echo "No destructive changes to apply."
          fi
        # You can switch to --pre-destructive-changes if your process requires deletions first

      - name: Upload delta artifact
        uses: actions/upload-artifact@v4
        with:
          name: delta-${{ github.sha }}
          path: delta/
          retention-days: 30

      - name: Upload drift check artifact
        if: always() && steps.drift_check.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-check-${{ github.sha }}
          path: drift-check/
          retention-days: 30

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [delta-deployment]
    if: failure()
    steps:
      - run: |
          echo "‚ùå UAT deployment failed!"
          echo "üîó Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo ""
          echo "üí° If deployment failed due to drift detection:"
          echo "   1. Check the drift-check artifact for details"
          echo "   2. Review org vs repository differences"
          echo "   3. Either sync drift to repo or set HALT_ON_DRIFT=false"
